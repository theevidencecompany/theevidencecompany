<!doctype html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-950TETZ642"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'G-950TETZ642');
  </script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Logit - probability conversion</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- React (UMD) + Babel for JSX -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- SheetJS (optional .xlsx support; also loaded on-demand as fallback) -->
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // Disable right-click
    document.addEventListener('contextmenu', e => e.preventDefault());

    const redirectHome = () => {
      window.location.href = "index.html";
    };

    // DevTools detection
    setInterval(() => {
      if (
        window.outerWidth - window.innerWidth > 160 ||
        window.outerHeight - window.innerHeight > 160
      ) {
        redirectHome();
      }
    }, 500);

    // Disable DevTools shortcuts
    document.addEventListener('keydown', e => {
      if (
        e.key === "F12" ||
        (e.ctrlKey && e.shiftKey && ["I","J","C"].includes(e.key)) ||
        (e.ctrlKey && e.key === "U")
      ) {
        e.preventDefault();
        redirectHome();
      }
    });
  </script>


  <style>
    /* THEME (exact values) */
    :root {
      --brand-primary: #184B44;
      --brand-light:   #2a6e64;
      --brand-accent:  #e6fffa;
    }

    body {
      background-color: #f0fdfa;
      background-image: radial-gradient(#ccfbf1 1px, transparent 1px);
      background-size: 20px 20px;
      color: #334155;
      margin: 0;
      overflow-x: hidden;
      font-family: 'Inter', sans-serif;
      font-size: 16px;
      line-height: 24px;
    }

    @keyframes fadeIn { from { opacity:0; transform: translateY(20px);} to {opacity:1; transform: translateY(0);} }
    .animate-fade-up { animation: fadeIn 0.6s cubic-bezier(0.4,0,0.2,1) forwards; opacity: 0; }

    .tool-card {
      background: white;
      border: 1px solid rgba(24, 75, 68, 0.1);
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
    }

    .btn-brand {
      background-color: var(--brand-primary);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 14px;
      line-height: 20px;
    }
    .btn-brand:hover {
      background-color: var(--brand-light);
      transform: translateY(-1px);
      box-shadow: 0 4px 6px -1px rgba(24,75,68,0.2);
    }

    .btn-secondary {
      background-color: white;
      color: #334155;
      border: 1px solid #e2e8f0;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 14px;
      line-height: 20px;
    }
    .btn-secondary:hover {
      border-color: var(--brand-primary);
      color: var(--brand-primary);
      background-color: #f8fafc;
    }

    .btn-danger {
      background-color: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 14px;
      line-height: 20px;
    }
    .btn-danger:hover {
      background-color: #fecaca;
      border-color: #f87171;
    }

    .toggle-checkbox:checked { right: 0; border-color: #184B44; }
    .toggle-checkbox:checked + .toggle-label { background-color: #184B44; }

    .modal-overlay {
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
    }

    /* Inputs (monospace for comma-separated values) */
    .mono-input {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 14px;
      line-height: 20px;
      font-weight: 400;
    }

    .logo-fallback { font-family: Gungsuh, serif; color: #184B44; }

    /* References block REQUIRED CHANGE */
    .references-plain {
      background-color: #f0fdfa;
      box-shadow: none;
      border: none;
      border-top: 1px solid rgba(24, 75, 68, 0.18);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    // -----------------------------
    // Internal-only utilities
    // -----------------------------

    function clamp(n, min, max) {
      return Math.min(max, Math.max(min, n));
    }

    function splitList(raw) {
      const s = String(raw ?? '');
      if (s.trim() === '') return [];
      const parts = s.split(',').map(t => t.trim());
      while (parts.length && parts[parts.length - 1] === '') parts.pop();
      return parts;
    }

    function parseNumberToken(token) {
      const t = String(token ?? '').trim();
      if (t === '') return { raw: '', ok: false, missing: true, val: NaN };
      const n = Number(t);
      if (Number.isFinite(n)) return { raw: t, ok: true, missing: false, val: n };
      return { raw: t, ok: false, missing: false, val: NaN };
    }

    function parseList(raw) {
      const tokens = splitList(raw);
      return tokens.map(parseNumberToken);
    }

    function detectDelimiter(line) {
      const c = (line.match(/,/g) || []).length;
      const t = (line.match(/\t/g) || []).length;
      const s = (line.match(/;/g) || []).length;
      const m = Math.max(c, t, s);
      if (m === t) return '\t';
      if (m === s) return ';';
      return ',';
    }

    function parseCSV(text, delim) {
      const rows = [];
      let row = [];
      let cur = '';
      let inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        const next = text[i + 1];
        if (ch === '"') {
          if (inQuotes && next === '"') {
            cur += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (!inQuotes && ch === delim) {
          row.push(cur);
          cur = '';
        } else if (!inQuotes && (ch === '\n' || ch === '\r')) {
          if (ch === '\r' && next === '\n') i++;
          row.push(cur);
          rows.push(row);
          row = [];
          cur = '';
        } else {
          cur += ch;
        }
      }
      if (cur.length || row.length) {
        row.push(cur);
        rows.push(row);
      }
      while (rows.length && rows[rows.length - 1].every(x => String(x ?? '').trim() === '')) rows.pop();
      return rows;
    }

    function looksLikeHeader(firstRow) {
      if (!firstRow || !firstRow.length) return false;
      let nonNumeric = 0;
      let numeric = 0;
      for (const cell of firstRow) {
        const t = String(cell ?? '').trim();
        if (!t) continue;
        const n = Number(t);
        if (Number.isFinite(n)) numeric++; else nonNumeric++;
      }
      return nonNumeric > 0 && nonNumeric >= numeric;
    }

    async function ensureXLSX() {
      if (window.XLSX) return;
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('Failed to load XLSX parser. Please retry.'));
        document.head.appendChild(s);
      });
    }

    // Numerically stable sigmoid
    function sigmoid(x) {
      if (!Number.isFinite(x)) return NaN;
      if (x >= 0) {
        const ex = Math.exp(-x);
        return 1 / (1 + ex);
      }
      const ex = Math.exp(x);
      return ex / (1 + ex);
    }

    function logitFromP(p) {
      if (p === 0) return -Infinity;
      if (p === 1) return Infinity;
      return Math.log(p / (1 - p));
    }

    function fmtInfinity(x) {
      if (x === Infinity) return '∞';
      if (x === -Infinity) return '−∞';
      return null;
    }

    // -----------------------------
    // UI helpers
    // -----------------------------

    function StatusIcon({ status }) {
      if (status === 'ok') {
        return (
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M20 6 9 17l-5-5" stroke="#166534" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" />
          </svg>
        );
      }
      if (status === 'warn') {
        return (
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 9v4" stroke="#b45309" strokeWidth="2.4" strokeLinecap="round" />
            <path d="M12 17h.01" stroke="#b45309" strokeWidth="3" strokeLinecap="round" />
            <path d="M10.3 4.3 2.6 18a2 2 0 0 0 1.7 3h15.4a2 2 0 0 0 1.7-3L13.7 4.3a2 2 0 0 0-3.4 0Z" stroke="#b45309" strokeWidth="2" />
          </svg>
        );
      }
      return (
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 8v5" stroke="#b91c1c" strokeWidth="2.4" strokeLinecap="round" />
          <path d="M12 16h.01" stroke="#b91c1c" strokeWidth="3" strokeLinecap="round" />
          <path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="#b91c1c" strokeWidth="2" />
        </svg>
      );
    }

    function InfoIconButton({ onClick, label }) {
      return (
        <button
          type="button"
          onClick={onClick}
          aria-label={label}
          className="inline-flex items-center justify-center w-7 h-7 rounded-full border border-slate-200 bg-white hover:border-[var(--brand-primary)] hover:shadow-sm transition"
        >
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 17v-6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
            <path d="M12 7h.01" stroke="currentColor" strokeWidth="3" strokeLinecap="round" />
            <path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" strokeWidth="2" />
          </svg>
        </button>
      );
    }

    function Modal({ open, title, children, onClose }) {
      if (!open) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" role="dialog" aria-modal="true">
          <div className="w-full max-w-3xl bg-white rounded-2xl border border-slate-200 shadow-2xl overflow-hidden">
            <div className="flex items-center justify-between gap-3 px-4 py-3 border-b border-slate-200">
              <div className="text-xl font-bold text-slate-800">{title}</div>
              <button type="button" className="btn-secondary" onClick={onClose}>Close</button>
            </div>
            <div className="p-4">{children}</div>
          </div>
        </div>
      );
    }

    function Tabs({ value, onChange, options }) {
      return (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
          {options.map((opt) => {
            const active = opt.value === value;
            return (
              <button
                key={opt.value}
                type="button"
                onClick={() => onChange(opt.value)}
                className={
                  "w-full text-left text-sm font-medium px-3 py-2 rounded-xl border transition leading-snug " +
                  (active
                    ? "bg-[var(--brand-primary)] text-white border-[var(--brand-primary)] shadow"
                    : "bg-white text-slate-700 border-slate-200 hover:border-[var(--brand-primary)]")
                }
              >
                {opt.label}
              </button>
            );
          })}
        </div>
      );
    }

    function InputBar({ id, label, helper, value, onChange, placeholder }) {
      return (
        <div className="w-full">
          <label className="block text-sm font-medium text-slate-800" htmlFor={id} title={helper}>{label}</label>
          <textarea
            id={id}
            value={value}
            onChange={(e) => onChange(e.target.value)}
            placeholder={placeholder}
            rows={2}
            className={
              "mono-input mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 " +
              "text-sm focus:outline-none focus:ring-4 focus:ring-[rgba(24,75,68,0.15)] focus:border-[var(--brand-primary)]"
            }
          />
          <div className="text-xs text-slate-500 mt-1 font-normal">{helper}</div>
        </div>
      );
    }

    // -----------------------------
    // App
    // -----------------------------

    const MODE = {
      LOGIT_TO_P: 'LOGIT_TO_P',
      P_TO_LOGIT: 'P_TO_LOGIT'
    };

    function App() {
      const [logoOk, setLogoOk] = useState(true);

      const [mode, setMode] = useState(MODE.LOGIT_TO_P);
      const [decimals, setDecimals] = useState(4);

      const [inputs, setInputs] = useState({
        logit: '',
        p: ''
      });

      const [fieldSummary, setFieldSummary] = useState({ kind: 'ok', text: 'Ready.' });

      const [results, setResults] = useState([]);
      const [lengthNote, setLengthNote] = useState('');
      const [csvText, setCsvText] = useState('');

      // File import
      const fileInputRef = useRef(null);
      const [dropActive, setDropActive] = useState(false);
      const [fileStatus, setFileStatus] = useState('No file loaded.');
      const [parsedFile, setParsedFile] = useState(null); // { rows, filename, headerGuess }

      // Column picker modal
      const [colModalOpen, setColModalOpen] = useState(false);
      const [hasHeader, setHasHeader] = useState(true);
      const [colSelection, setColSelection] = useState(0);

      // Infographic modal
      const [infoOpen, setInfoOpen] = useState(false);

      const requiredKey = mode === MODE.LOGIT_TO_P ? 'logit' : 'p';

      const inputMeta = useMemo(() => ({
        logit: {
          label: 'Logit values',
          helper: 'Comma-separated list of logit values (finite numbers).',
          placeholder: 'e.g., -1.2, 0, 2.5'
        },
        p: {
          label: 'Probabilities (p)',
          helper: 'Comma-separated list of probabilities in [0, 1].',
          placeholder: 'e.g., 0.12, 0.5, 0.92'
        }
      }), []);

      function updateInput(key, value) {
        setInputs((prev) => ({ ...prev, [key]: value }));
      }

      const formatNumber = useMemo(() => {
        return (x) => {
          const inf = fmtInfinity(x);
          if (inf) return inf;
          if (x === null || x === undefined) return '—';
          if (typeof x !== 'number') return '—';
          if (!Number.isFinite(x)) return '—';
          const s = x.toFixed(decimals);
          // Trim trailing zeros without changing requested precision too aggressively
          return s;
        };
      }, [decimals]);

      useEffect(() => {
        const problems = [];

        const parsed = parseList(inputs[requiredKey]);
        const bad = parsed.filter(t => !t.ok);
        if (bad.length) {
          const samples = bad.slice(0, 5).map(t => (t.missing ? '(blank)' : `'${t.raw}'`)).join(', ');
          problems.push(`${inputMeta[requiredKey].label}: invalid value(s) → ${samples}${bad.length > 5 ? '…' : ''}`);
        }

        const nums = parsed.filter(t => t.ok).map(t => t.val);

        if (requiredKey === 'p') {
          const outOfRange = nums.some(n => n < 0 || n > 1);
          if (outOfRange) problems.push('Probabilities must be within [0, 1].');
        }

        if (requiredKey === 'logit') {
          const nonFinite = nums.some(n => !Number.isFinite(n));
          if (nonFinite) problems.push('Logit values must be finite numbers.');
        }

        if (problems.length) setFieldSummary({ kind: 'err', text: problems[0] + (problems.length > 1 ? ` (+${problems.length - 1} more)` : '') });
        else setFieldSummary({ kind: 'ok', text: 'Ready.' });
      }, [inputs, requiredKey, inputMeta]);

      const assumptions = useMemo(() => ([
        'Logit is the natural log of odds; probability is a value in [0,1].',
        'Edge probabilities p=0 or p=1 map to infinite logits; this is expected mathematically.',
        'Conversions are deterministic and do not represent uncertainty intervals.'
      ]), []);

      function alignRows() {
        const parsed = parseList(inputs[requiredKey]);
        const minLen = parsed.length;
        return { tokens: parsed, minLen };
      }

      function computeRow(token, idx) {
        // Non-blocking per-row validation
        if (!token.ok) {
          return {
            status: 'err',
            message: token.missing ? 'Missing input.' : 'Invalid input.',
            input: token.missing ? '' : token.raw,
            output: null,
            warnings: token.missing ? 'Blank value.' : 'Not a number.'
          };
        }

        const v = token.val;

        try {
          if (mode === MODE.LOGIT_TO_P) {
            if (!Number.isFinite(v)) {
              return { status: 'err', message: 'Invalid input.', input: token.raw, output: null, warnings: 'Logit must be finite.' };
            }
            const p = sigmoid(v);
            if (!Number.isFinite(p) && p !== 0 && p !== 1) {
              return { status: 'err', message: 'Cannot compute.', input: v, output: null, warnings: 'Numerical issue.' };
            }
            return {
              status: 'ok',
              message: 'Computed.',
              input: v,
              output: p,
              warnings: ''
            };
          }

          // P_TO_LOGIT
          if (v < 0 || v > 1) {
            return {
              status: 'err',
              message: 'Invalid probability.',
              input: v,
              output: null,
              warnings: 'p must be within [0, 1].'
            };
          }
          if (v === 0) {
            return {
              status: 'warn',
              message: 'Edge case.',
              input: v,
              output: -Infinity,
              warnings: 'p=0 maps to −∞ logit.'
            };
          }
          if (v === 1) {
            return {
              status: 'warn',
              message: 'Edge case.',
              input: v,
              output: Infinity,
              warnings: 'p=1 maps to ∞ logit.'
            };
          }
          const lg = logitFromP(v);
          return {
            status: 'ok',
            message: 'Computed.',
            input: v,
            output: lg,
            warnings: ''
          };
        } catch (e) {
          return {
            status: 'err',
            message: 'Cannot compute.',
            input: token.raw,
            output: null,
            warnings: String(e?.message || e)
          };
        }
      }

      function buildCsv(rows) {
        const header = ['mode', 'decimals', 'row_index', 'input_value', 'output_value', 'status', 'message', 'warnings'];
        const modeLabel = mode === MODE.LOGIT_TO_P ? 'Logit → Probability' : 'Probability → Logit';
        const lines = [header.join(',')];
        for (const r of rows) {
          const out = (r.output === Infinity) ? 'Infinity' : (r.output === -Infinity ? '-Infinity' : (typeof r.output === 'number' ? r.output : ''));
          const input = (r.input === Infinity) ? 'Infinity' : (r.input === -Infinity ? '-Infinity' : r.input);
          const vals = {
            mode: modeLabel,
            decimals,
            row_index: r.idx + 1,
            input_value: input,
            output_value: out,
            status: r.status,
            message: r.message,
            warnings: r.warnings
          };
          const line = header.map(k => csvEscape(vals[k]));
          lines.push(line.join(','));
        }
        return lines.join('\n');
      }

      function csvEscape(x) {
        const s = String(x ?? '');
        if (/[\n\r,\"]/g.test(s)) return '"' + s.replace(/\"/g, '""') + '"';
        return s;
      }

      function run() {
        setResults([]);
        setLengthNote('');

        const { tokens, minLen } = alignRows();
        if (minLen === 0) {
          setResults([]);
          setLengthNote('No rows to process. Enter comma-separated values in the input bar.');
          setCsvText('');
          return;
        }

        const computed = tokens.map((t, i) => ({ ...computeRow(t, i), idx: i }));
        setResults(computed);
        setCsvText(buildCsv(computed));
      }

      async function copyCsv() {
        try {
          await navigator.clipboard.writeText(csvText || '');
        } catch {
          alert('Clipboard copy failed in this browser. You can still use Download CSV.');
        }
      }

      function downloadCsv() {
        const blob = new Blob([csvText || ''], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'entro_py_logit_probability_results.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function resetAll() {
        setMode(MODE.LOGIT_TO_P);
        setDecimals(4);
        setInputs({ logit: '', p: '' });
        setResults([]);
        setLengthNote('');
        setCsvText('');
        setParsedFile(null);
        setFileStatus('No file loaded.');
        setColModalOpen(false);
        setHasHeader(true);
        setColSelection(0);
        setInfoOpen(false);
      }

      // -----------------------------
      // File upload + column picker
      // -----------------------------

      async function handleFile(file) {
        const name = file?.name || 'file';
        const ext = name.toLowerCase().split('.').pop();
        setFileStatus(`Loaded: ${name}`);

        try {
          let rows;
          if (ext === 'csv' || ext === 'txt') {
            const text = await file.text();
            const firstLine = text.split(/\r?\n/)[0] ?? '';
            const delim = detectDelimiter(firstLine);
            rows = parseCSV(text, delim);
          } else if (ext === 'xlsx') {
            await ensureXLSX();
            const buf = await file.arrayBuffer();
            const wb = window.XLSX.read(buf, { type: 'array' });
            const sheetName = wb.SheetNames[0];
            const ws = wb.Sheets[sheetName];
            rows = window.XLSX.utils.sheet_to_json(ws, { header: 1, raw: false, defval: '' });
          } else {
            throw new Error('Unsupported file type. Please upload .csv, .txt, or .xlsx.');
          }

          if (!rows || rows.length < 1) throw new Error('File appears empty.');

          const headerGuess = looksLikeHeader(rows[0]);
          setParsedFile({ rows, filename: name, headerGuess });
          setHasHeader(headerGuess);

          // init selection
          const maxCols = Math.max(1, ...rows.map(r => (r ? r.length : 0)));
          setColSelection(0);
          if (maxCols === 1) setColSelection(0);

          setColModalOpen(true);
        } catch (e) {
          setParsedFile(null);
          setFileStatus('No file loaded.');
          alert(String(e?.message || e));
        }
      }

      function colName(rows, idx, headerOn) {
        const maxCols = Math.max(1, ...rows.map(r => (r ? r.length : 0)));
        const defaultNames = Array.from({ length: maxCols }, (_, i) => `Column ${String.fromCharCode(65 + i)}`);
        if (!headerOn) return defaultNames[idx] || `Column ${idx + 1}`;
        const h = String(rows?.[0]?.[idx] ?? '').trim();
        return h ? h : (defaultNames[idx] || `Column ${idx + 1}`);
      }

      function applyColumn() {
        if (!parsedFile) return;
        const { rows } = parsedFile;
        const start = hasHeader ? 1 : 0;
        const idx = Number(colSelection);

        const vals = [];
        for (let i = start; i < rows.length; i++) {
          const r = rows[i] || [];
          vals.push(String(r[idx] ?? '').trim());
        }

        const key = requiredKey;
        setInputs((prev) => ({ ...prev, [key]: vals.join(', ') }));
        setColModalOpen(false);
        setResults([]);
        setCsvText('');
      }

      const modeOptions = [
        { value: MODE.LOGIT_TO_P, label: 'Logit → Probability' },
        { value: MODE.P_TO_LOGIT, label: 'Probability → Logit' }
      ];

      const canCopy = results.length > 0 && (csvText || '').length > 0;

      const statusColor = fieldSummary.kind === 'err'
        ? 'text-red-700'
        : fieldSummary.kind === 'warn'
          ? 'text-amber-700'
          : 'text-emerald-700';

      const activeInputKey = requiredKey;
      const outLabel = mode === MODE.LOGIT_TO_P ? 'Probability (p)' : 'Logit';
      const inLabel = mode === MODE.LOGIT_TO_P ? 'Logit' : 'Probability (p)';

      return (
        <div className="min-h-screen flex flex-col">
          {/* Header */}
          <header className="sticky top-0 z-40 bg-[rgba(240,253,250,0.75)] backdrop-blur border-b border-slate-200">
            <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
              <div className="flex items-center gap-3 min-w-[220px]">
                {logoOk ? (
                  <img
                    src="Entropy.png"
                    alt="Entropy"
                    className="h-9 w-auto"
                    onError={() => setLogoOk(false)}
                  />
                ) : (
                  <div className="logo-fallback" aria-hidden="true">
                    <span style={{ fontSize: 30, fontWeight: 400 }}>Σntr</span>
                    <span style={{ fontSize: 22.5, fontWeight: 700 }}>Ω</span>
                    <span style={{ fontSize: 30, fontWeight: 400 }}>.py</span>
                  </div>
                )}
              </div>
              <a
                className="btn-secondary"
                href="Convert Statistical Quantities.html"
                title="Return to the tools list"
              >
                <span aria-hidden="true">←</span>
                <span>Back to Tools</span>
              </a>
            </div>
          </header>

          {/* Main */}
          <main className="flex-1">
            <div className="max-w-6xl mx-auto px-4 py-8">
              <section className="animate-fade-up" style={{ animationDelay: '0.05s' }}>
                <h1 className="text-3xl font-bold text-[#184B44] mb-3 text-center">Logit - probability conversion</h1>
                <p className="text-sm text-slate-600 leading-relaxed text-center">
                  Convert between logit (log-odds) values and probabilities, using batch inputs or bulk imports.
                </p>
              </section>

              {/* Assumptions */}
              <section className="animate-fade-up mt-5" style={{ animationDelay: '0.10s' }}>
                <div className="rounded-2xl border border-amber-200 bg-amber-50 p-4">
                  <div>
                    <div className="text-lg font-semibold text-slate-800">Assumptions</div>
                    <div className="text-sm text-slate-600 leading-relaxed">These conversions are deterministic and do not represent uncertainty intervals.</div>
                  </div>
                  <ul className="mt-3 list-disc pl-5 text-sm text-slate-700 leading-relaxed">
                    {assumptions.map((a, i) => (<li key={i} className="mt-2">{a}</li>))}
                  </ul>
                </div>
              </section>

              {/* Calculator */}
              <section className="animate-fade-up mt-6" style={{ animationDelay: '0.15s' }}>
                <div className="tool-card">
                  {/* Mode selector + infographic */}
                  <div className="flex flex-col gap-3">
                    <div className="flex items-center justify-between gap-3">
                      <div>
                        <div className="text-lg font-semibold text-slate-800">Mode</div>
                        <div className="text-sm text-slate-600">Pick a direction to convert.</div>
                      </div>
                      <div className="flex items-center gap-2">
                        <InfoIconButton onClick={() => setInfoOpen(true)} label="Open info" />
                      </div>
                    </div>
                    <Tabs
                      value={mode}
                      onChange={(v) => {
                        setMode(v);
                        setResults([]);
                        setCsvText('');
                        setLengthNote('');
                      }}
                      options={modeOptions}
                    />
                  </div>

                  {/* Formatting */}
                  <div className="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-5">
                    <div className="rounded-2xl border border-slate-200 bg-slate-50/50 p-4">
                      <div className="text-lg font-semibold text-slate-800">Output formatting</div>
                      <div className="mt-3 flex items-center gap-3">
                        <label className="text-sm font-medium text-slate-800" htmlFor="decimals">Decimals</label>
                        <input
                          id="decimals"
                          type="range"
                          min="2"
                          max="8"
                          step="1"
                          value={decimals}
                          onChange={(e) => setDecimals(Number(e.target.value))}
                          className="w-full"
                          aria-label="Decimals slider"
                        />
                        <input
                          type="number"
                          min="2"
                          max="8"
                          step="1"
                          value={decimals}
                          onChange={(e) => setDecimals(clamp(Number(e.target.value), 2, 8))}
                          className="w-20 rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-4 focus:ring-[rgba(24,75,68,0.15)] focus:border-[var(--brand-primary)]"
                          aria-label="Decimals numeric"
                        />
                      </div>
                      <div className="text-xs text-slate-500 mt-2 font-normal">Infinity values display as ∞ / −∞ and export as Infinity / -Infinity.</div>
                    </div>

                    <div className="rounded-2xl border border-slate-200 bg-slate-50/50 p-4">
                      <div className="text-lg font-semibold text-slate-800">Input validation</div>
                      <div className="mt-2 text-sm text-slate-600 leading-relaxed">
                        Mixed valid/invalid entries are handled per row. Invalid rows are flagged without stopping the run.
                      </div>
                      <div className={"mt-3 text-sm leading-relaxed " + statusColor}>
                        <span className="font-medium">{fieldSummary.kind === 'ok' ? 'Ready:' : 'Input issues:'}</span>
                        <span className="ml-2 text-slate-700">{fieldSummary.text}</span>
                      </div>
                    </div>
                  </div>

                  {/* Split: Inputs + Output */}
                  <div className="mt-8 grid grid-cols-1 lg:grid-cols-12 gap-6">
                    {/* Inputs */}
                    <div className="min-w-0 lg:col-span-5">
                      <div className="flex items-center justify-between gap-3">
                        <div>
                          <div className="text-lg font-semibold text-slate-800">Inputs</div>
                          <div className="text-sm text-slate-600">Manual entry (comma-separated) or file upload.</div>
                        </div>
                        <div className="text-xs text-slate-600 bg-slate-50 border border-slate-200 rounded-full px-3 py-1">Separate input bar</div>
                      </div>

                      <div className="mt-4">
                        <InputBar
                          id="primary"
                          label={inputMeta[activeInputKey].label}
                          helper={inputMeta[activeInputKey].helper}
                          value={inputs[activeInputKey]}
                          onChange={(v) => updateInput(activeInputKey, v)}
                          placeholder={inputMeta[activeInputKey].placeholder}
                        />
                      </div>

                      {/* Upload */}
                      <details className="mt-5 rounded-2xl border border-slate-200 bg-white/70 p-4">
                        <summary className="cursor-pointer text-sm font-medium text-slate-800">
                          File upload (optional)
                          <span className="ml-2 text-xs font-normal text-slate-500">{fileStatus}</span>
                        </summary>

                        <div
                          className={
                            "mt-3 rounded-2xl border-2 border-dashed p-4 transition " +
                            (dropActive ? "border-[var(--brand-primary)] bg-[rgba(230,255,250,0.6)]" : "border-slate-300 bg-white/70")
                          }
                          onDragEnter={(e) => { e.preventDefault(); e.stopPropagation(); setDropActive(true); }}
                          onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); setDropActive(true); }}
                          onDragLeave={(e) => { e.preventDefault(); e.stopPropagation(); setDropActive(false); }}
                          onDrop={(e) => {
                            e.preventDefault(); e.stopPropagation();
                            setDropActive(false);
                            const f = e.dataTransfer?.files?.[0];
                            if (f) handleFile(f);
                          }}
                          role="button"
                          tabIndex={0}
                          aria-label="Upload a CSV, TXT, or XLSX file"
                        >
                          <div className="flex items-start justify-between gap-4">
                            <div>
                              <div className="text-sm font-medium text-slate-800">Drag & drop a .csv, .txt, or .xlsx file</div>
                              <div className="text-xs text-slate-500 mt-1 font-normal">Upload → parse → choose column → populate input.</div>
                            </div>
                            <button
                              type="button"
                              className="btn-secondary"
                              onClick={() => fileInputRef.current?.click()}
                            >
                              Browse files
                            </button>
                            <input
                              ref={fileInputRef}
                              type="file"
                              accept=".csv,.txt,.xlsx"
                              className="hidden"
                              onChange={(e) => {
                                const f = e.target.files?.[0];
                                if (f) handleFile(f);
                                e.target.value = '';
                              }}
                            />
                          </div>
                        </div>
                      </details>

                      <div className="mt-5 flex flex-wrap gap-3">
                        <button type="button" className="btn-brand" onClick={run}>
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M5 12h14" stroke="white" strokeWidth="2" strokeLinecap="round" />
                            <path d="M13 5l7 7-7 7" stroke="white" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                          </svg>
                          Run
                        </button>
                        <button type="button" className="btn-danger" onClick={resetAll}>Reset</button>
                      </div>

                      {lengthNote ? (
                        <div className="mt-3 text-sm text-amber-700 leading-relaxed">
                          <span className="font-medium">Note:</span> {lengthNote}
                        </div>
                      ) : null}
                    </div>

                    {/* Output */}
                    <div className="min-w-0 lg:col-span-7">
                      <div className="flex items-start justify-between gap-4">
                        <div>
                          <div className="text-lg font-semibold text-slate-800">Results</div>
                          <div className="text-sm text-slate-600">Per-row output with warning flags.</div>
                        </div>
                        <div className="flex flex-wrap gap-2 justify-end">
                          <button type="button" className="btn-secondary" onClick={copyCsv} disabled={!canCopy}>Copy to Clipboard</button>
                          <button type="button" className="btn-secondary" onClick={downloadCsv} disabled={!canCopy}>Download CSV</button>
                        </div>
                      </div>

                      <div className="mt-3 flex flex-wrap gap-2">
                        <span className="text-xs text-slate-600 bg-slate-50 border border-slate-200 rounded-full px-3 py-1">
                          {results.length} row{results.length === 1 ? '' : 's'}
                        </span>
                        <span className="text-xs text-slate-600 bg-slate-50 border border-slate-200 rounded-full px-3 py-1">
                          Output: {outLabel}
                        </span>
                      </div>

                      <div className="mt-4 border border-slate-200 rounded-2xl bg-white overflow-auto" style={{ maxHeight: 460 }}>
                        <table className="min-w-[860px] w-full border-collapse">
                          <thead className="sticky top-0 bg-slate-50">
                            <tr>
                              <th className="text-left text-xs font-semibold text-slate-600 uppercase tracking-wider px-3 py-2 border-b border-slate-200">Row</th>
                              <th className="text-left text-xs font-semibold text-slate-600 uppercase tracking-wider px-3 py-2 border-b border-slate-200">Status</th>
                              <th className="text-left text-xs font-semibold text-slate-600 uppercase tracking-wider px-3 py-2 border-b border-slate-200">{inLabel}</th>
                              <th className="text-left text-xs font-semibold text-slate-600 uppercase tracking-wider px-3 py-2 border-b border-slate-200">{outLabel}</th>
                              <th className="text-left text-xs font-semibold text-slate-600 uppercase tracking-wider px-3 py-2 border-b border-slate-200">Message</th>
                              <th className="text-left text-xs font-semibold text-slate-600 uppercase tracking-wider px-3 py-2 border-b border-slate-200">Warnings</th>
                            </tr>
                          </thead>
                          <tbody>
                            {results.length === 0 ? (
                              <tr>
                                <td colSpan={6} className="px-3 py-4 text-sm text-slate-500">Run the calculator to see results.</td>
                              </tr>
                            ) : (
                              results.map((r, i) => {
                                const rowBg = i % 2 === 0 ? 'bg-white' : 'bg-slate-50/40';
                                const msgCls = r.status === 'err' ? 'text-red-700' : (r.status === 'warn' ? 'text-amber-700' : 'text-emerald-700');
                                const inputDisplay = (typeof r.input === 'number') ? formatNumber(r.input) : String(r.input ?? '');
                                const outputDisplay = (typeof r.output === 'number') ? formatNumber(r.output) : '—';
                                return (
                                  <tr key={i} className={rowBg + ' hover:bg-[rgba(240,253,250,0.75)]'}>
                                    <td className="px-3 py-2 border-b border-slate-100 text-sm text-slate-700" style={{ fontVariantNumeric: 'tabular-nums' }}>{i + 1}</td>
                                    <td className="px-3 py-2 border-b border-slate-100">
                                      <div className="flex items-center gap-2">
                                        <StatusIcon status={r.status} />
                                        <span className="text-xs text-slate-600 font-medium">{String(r.status || '').toUpperCase()}</span>
                                      </div>
                                    </td>
                                    <td className="px-3 py-2 border-b border-slate-100 text-sm text-slate-700" style={{ fontVariantNumeric: 'tabular-nums' }}>{inputDisplay}</td>
                                    <td className="px-3 py-2 border-b border-slate-100 text-sm text-slate-700" style={{ fontVariantNumeric: 'tabular-nums' }}>{outputDisplay}</td>
                                    <td className={"px-3 py-2 border-b border-slate-100 text-sm " + msgCls}>{r.message}</td>
                                    <td className="px-3 py-2 border-b border-slate-100 text-sm text-slate-700">{r.warnings || ''}</td>
                                  </tr>
                                );
                              })
                            )}
                          </tbody>
                        </table>
                      </div>

                      <div className="mt-3 text-sm text-slate-600 leading-relaxed">
                        Exported CSV includes inputs, outputs, and warning flags.
                      </div>
                    </div>
                  </div>
                </div>
              </section>

              {/* References (required styling: no raised card) */}
              <section className="animate-fade-up mt-8" style={{ animationDelay: '0.20s' }}>
                <div className="references-plain rounded-2xl px-6 py-5">
                  <div className="text-lg font-semibold text-slate-800">References</div>
                  <div className="mt-2 text-sm text-slate-700 leading-relaxed">
                    Calculation note: This calculator uses the logit link (log-odds) and its inverse (logistic function) to convert between logits and probabilities.
                  </div>
                  <ul className="mt-3 list-disc pl-5 text-sm text-slate-700 leading-relaxed">
                    <li>Bewick, V., Cheek, L., &amp; Ball, J. (2005). Statistics review 14: Logistic regression. <span className="italic">Critical Care, 9</span>(1), 112–118. https://doi.org/10.1186/cc3045</li>
                  </ul>
                </div>
              </section>
            </div>
          </main>

          {/* Footer (NO ADSENSE PLACEHOLDER) */}
          <footer className="border-t border-slate-200 bg-white">
            <div className="max-w-6xl mx-auto px-4 py-6 text-center">
              <div className="text-sm text-slate-600">© {new Date().getFullYear()} Threadminds. All rights reserved.</div>
            </div>
          </footer>

          {/* Column picker modal */}
          <Modal
            open={colModalOpen}
            title={parsedFile?.filename ? `Select a column — ${parsedFile.filename}` : 'Select a column'}
            onClose={() => setColModalOpen(false)}
          >
            {!parsedFile ? (
              <div className="text-sm text-slate-600">No file loaded.</div>
            ) : (
              <div>
                <p className="text-sm text-slate-600 leading-relaxed">
                  Choose the file column to import into the <span className="font-medium text-slate-800">{inputMeta[requiredKey].label}</span> input bar.
                </p>

                <div className="mt-4 flex items-center gap-3">
                  <input
                    id="hdr"
                    type="checkbox"
                    checked={hasHeader}
                    onChange={(e) => setHasHeader(e.target.checked)}
                    className="h-4 w-4"
                  />
                  <label htmlFor="hdr" className="text-sm text-slate-700">Treat first row as headers</label>
                  <span className="text-xs text-slate-500 font-normal">{parsedFile.filename} · {parsedFile.rows.length} rows</span>
                </div>

                <div className="mt-4">
                  <label className="block text-sm font-medium text-slate-800">Column</label>
                  <select
                    className="mt-2 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-4 focus:ring-[rgba(24,75,68,0.15)] focus:border-[var(--brand-primary)]"
                    value={String(colSelection)}
                    onChange={(e) => setColSelection(Number(e.target.value))}
                  >
                    {Array.from({ length: Math.max(1, ...parsedFile.rows.map(r => (r ? r.length : 0))) }, (_, i) => (
                      <option key={i} value={i}>{colName(parsedFile.rows, i, hasHeader)}</option>
                    ))}
                  </select>
                  <div className="text-xs text-slate-500 mt-1 font-normal">The selected column will be imported as a comma-separated list.</div>
                </div>

                <div className="mt-5 flex flex-wrap gap-3 justify-end">
                  <button type="button" className="btn-secondary" onClick={() => setColModalOpen(false)}>Cancel</button>
                  <button type="button" className="btn-brand" onClick={applyColumn}>Apply column</button>
                </div>
              </div>
            )}
          </Modal>

          {/* Infographic modal (placeholder) */}
          <Modal
            open={infoOpen}
            title="WTH are Logits and Probabilities"
            onClose={() => setInfoOpen(false)}
          >
            <div className="w-full overflow-hidden rounded-2xl border border-slate-200 bg-slate-50" style={{ aspectRatio: '11 / 6' }}>
              <div className="w-full h-full flex items-center justify-center text-sm text-slate-500"><img
                src="logits.png"/></div>
            </div>
            <div className="mt-3 rounded-2xl border border-slate-200 bg-white p-3">
              {/* Placeholder text area (non-editable). Add content here later in the HTML code. */}
              <div className="text-sm text-slate-500 leading-relaxed">This infographic visualizes how statistics translates "logits," which exist on an infinite scale from negative to positive infinity, into usable "probabilities" constrained between 0 and 1. The central "sigmoid function" acts like a funnel, "squeezing" the unbounded logit values into that tight probability window. A logit of zero perfectly translates to a 0.5 (or 50%) probability. The crucial concept shown at the top and bottom is that as logits get infinitely large or infinitely small, they are all compressed into the exact terminal points of Probability = 1 (certainty) and Probability = 0 (impossibility), respectively. Therefore, these two terminal probabilities represent "sinks" that absorb an infinite number of extreme logit values.</div>
            </div>
          </Modal>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
