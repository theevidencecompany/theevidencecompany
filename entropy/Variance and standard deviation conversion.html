<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-950TETZ642"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-950TETZ642');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Variance & SD Conversion - Entro.py</title>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Disable right-click
        document.addEventListener('contextmenu', e => e.preventDefault());
    
        const redirectHome = () => {
          window.location.href = "index.html";
        };
    
        // DevTools detection
        setInterval(() => {
          if (
            window.outerWidth - window.innerWidth > 160 ||
            window.outerHeight - window.innerHeight > 160
          ) {
            redirectHome();
          }
        }, 500);
    
        // Disable DevTools shortcuts
        document.addEventListener('keydown', e => {
          if (
            e.key === "F12" ||
            (e.ctrlKey && e.shiftKey && ["I","J","C"].includes(e.key)) ||
            (e.ctrlKey && e.key === "U")
          ) {
            e.preventDefault();
            redirectHome();
          }
        });
      </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --brand-primary: #184B44;
            --brand-light: #2a6e64;
            --brand-accent: #e6fffa;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0fdfa;
            background-image: radial-gradient(#ccfbf1 1px, transparent 1px);
            background-size: 20px 20px;
            margin: 0;
            overflow-x: hidden;
            color: #334155;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-up {
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            opacity: 0;
        }

        /* Card Styles */
        .tool-card {
            background: white;
            border: 1px solid rgba(24, 75, 68, 0.1);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        /* Button Styles */
        .btn-brand {
            background-color: var(--brand-primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-brand:hover {
            background-color: var(--brand-light);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(24, 75, 68, 0.2);
        }
        .btn-secondary {
            background-color: white;
            color: #334155;
            border: 1px solid #e2e8f0;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-secondary:hover {
            border-color: var(--brand-primary);
            color: var(--brand-primary);
            background-color: #f8fafc;
        }
        .btn-danger {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-danger:hover {
            background-color: #fecaca;
            border-color: #f87171;
        }

        /* Header Gradient */
        .header-bg {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(24, 75, 68, 0.1);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef } = React;

        // --- Icons ---
        const ArrowLeft = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>;
        const UploadCloud = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>;
        const Calculator = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>;
        const Download = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>;
        const Copy = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>;
        const AlertCircle = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>;
        const RefreshCw = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>;

        function App() {
            const [mode, setMode] = useState('sd_to_var'); // 'sd_to_var' or 'var_to_sd'
            const [inputType, setInputType] = useState('manual'); // 'manual' or 'file'
            const [inputValue, setInputValue] = useState('');
            const [results, setResults] = useState([]);
            const [fileData, setFileData] = useState(null); // Store parsed CSV data
            const [headers, setHeaders] = useState([]); // Store CSV headers
            const [selectedColumn, setSelectedColumn] = useState(''); // Selected column for processing
            const [showColumnSelector, setShowColumnSelector] = useState(false);
            const fileInputRef = useRef(null);

            const handleReset = () => {
                setInputValue('');
                setResults([]);
                setFileData(null);
                setHeaders([]);
                setSelectedColumn('');
                setShowColumnSelector(false);
                setInputType('manual');
                if (fileInputRef.current) fileInputRef.current.value = "";
            };

            const calculateRow = (val, idx) => {
                const trimmedVal = val ? String(val).trim() : "";
                
                // Strict validation: Check if empty
                if (trimmedVal === "") return { id: idx, input: "", output: null, error: 'Empty' };

                // Strict validation: Check if it's a valid number format (no letters)
                // Number() returns NaN for "12a", whereas parseFloat returns 12. 
                // We use Number() for strictness.
                const num = Number(trimmedVal);

                if (isNaN(num)) return { id: idx, input: trimmedVal, output: null, error: 'Invalid Input (String/Alpha)' };
                if (num < 0) return { id: idx, input: trimmedVal, output: null, error: 'Negative Value' };

                let output;
                if (mode === 'sd_to_var') {
                    // Variance = SD^2
                    output = Math.pow(num, 2);
                } else {
                    // SD = sqrt(Variance)
                    output = Math.sqrt(num);
                }
                return { id: idx, input: num, output: output, error: null };
            };

            const handleCalculate = () => {
                let data = [];
                if (inputType === 'manual') {
                    data = inputValue.split(',').map(s => s); // keep original strings for validation
                } else {
                    return; // Should be handled by handleFileProcess for file flow
                }

                const newResults = data.map((val, idx) => calculateRow(val, idx));
                setResults(newResults);
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const text = event.target.result;
                    const rows = text.split('\n').map(row => row.split(','));
                    
                    if (rows.length > 0) {
                        // Assume first row is header
                        const potentialHeaders = rows[0].map(h => h.trim());
                        setHeaders(potentialHeaders);
                        setFileData(rows); // Store full data
                        setShowColumnSelector(true);
                        setSelectedColumn(''); 
                        setResults([]); // Clear previous results
                    }
                };
                reader.readAsText(file);
            };

            const handleFileProcess = () => {
                if (selectedColumn === "") {
                    alert("Please select a column to process.");
                    return;
                }

                const colIndex = parseInt(selectedColumn);
                // Extract data from the selected column, skipping header row (index 0)
                const dataToProcess = fileData.slice(1).map(row => row[colIndex]);
                
                const newResults = dataToProcess.map((val, idx) => calculateRow(val, idx));
                
                setResults(newResults);
                setShowColumnSelector(false); // Hide selector after processing
                setInputType('manual'); // Show results view
                // Optionally populate manual box, or just leave it empty since results are shown
                setInputValue(dataToProcess.filter(v => v !== undefined).join(', ')); 
            };

            const exportCSV = () => {
                const header = mode === 'sd_to_var' ? "Standard Deviation,Variance,Status" : "Variance,Standard Deviation,Status";
                const rows = results.map(r => `${r.input},${r.output !== null ? r.output : ''},${r.error || 'Success'}`).join("\n");
                const csvContent = "data:text/csv;charset=utf-8," + header + "\n" + rows;
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "conversion_results.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const copyToClipboard = () => {
                const text = results.map(r => `${r.input}\t${r.output !== null ? r.output : r.error}`).join("\n");
                navigator.clipboard.writeText(text).then(() => alert("Copied to clipboard!"));
            };

            return (
                <div className="min-h-screen flex flex-col">
                    {/* Header */}
                    <header className="header-bg py-4 sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-6 flex items-center justify-between">
                            <div className="flex items-center gap-2 cursor-pointer" onClick={() => window.location.href='index.html'}>
                                <img src="Entropy.png" alt="Entro.py" className="h-8" />
                            </div>
                            <a href="Convert Statistical Quantities.html" className="text-sm font-medium text-[#184B44] hover:text-[#2a6e64] transition-colors flex items-center gap-1">
                                <ArrowLeft /> Back to Convert Statistical Quantities
                            </a>
                        </div>
                    </header>

                    <main className="flex-grow max-w-5xl mx-auto px-6 py-12 w-full z-0">
                        
                        {/* Title & Description */}
                        <div className="text-center mb-10 animate-fade-up">
                            <h1 className="text-3xl font-bold text-[#184B44] mb-3">Variance and Standard Deviation Conversion</h1>
                            <p className="text-slate-600 max-w-2xl mx-auto">
                                Convert between dispersion measures when different papers report different forms.
                                Essential for standardizing data in meta-analyses.
                            </p>
                        </div>

                        {/* Assumptions Box - Highlighted */}
                        <div className="max-w-3xl mx-auto mb-8 animate-fade-up" style={{animationDelay: '0.15s'}}>
                            <div className="bg-[#fffbeb] border border-[#fcd34d] rounded-lg p-5 shadow-sm">
                                <h3 className="font-semibold text-[#92400e] flex items-center gap-2 mb-2">
                                    <AlertCircle /> Assumptions & Constraints
                                </h3>
                                <ul className="list-disc pl-5 space-y-2 text-sm text-[#92400e]/90">
                                    <li>The data must be numerical (quantitative), not categorical or purely ordinal.</li>
                                    <li>Variance is always ≥ 0, and Standard Deviation is always ≥ 0.</li>
                                    <li>Ensure consistent definition when converting:
                                        <div className="flex flex-col mt-1 gap-1 font-medium">
                                            <span className="flex items-center gap-2"><span className="text-green-600">✓</span> sample variance → sample SD</span>
                                            <span className="flex items-center gap-2"><span className="text-red-600">✗</span> sample variance → population SD</span>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        {/* Calculator Card */}
                        <div className="tool-card animate-fade-up" style={{animationDelay: '0.2s'}}>
                            
                            {/* Mode Toggle */}
                            <div className="flex flex-wrap justify-center gap-4 mb-8 border-b border-slate-100 pb-6">
                                <button 
                                    onClick={() => { setMode('sd_to_var'); setResults([]); }}
                                    className={`px-4 py-2 rounded-full text-sm font-medium transition-all ${mode === 'sd_to_var' ? 'bg-[#184B44] text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                                >
                                    SD → Variance
                                </button>
                                <button 
                                    onClick={() => { setMode('var_to_sd'); setResults([]); }}
                                    className={`px-4 py-2 rounded-full text-sm font-medium transition-all ${mode === 'var_to_sd' ? 'bg-[#184B44] text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                                >
                                    Variance → SD
                                </button>
                                <button 
                                    onClick={handleReset}
                                    className="ml-auto btn-danger"
                                    title="Clear all data"
                                >
                                    <RefreshCw className="w-4 h-4" /> Reset
                                </button>
                            </div>

                            {/* Input Section */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        Input {mode === 'sd_to_var' ? 'Standard Deviations' : 'Variances'}
                                    </label>
                                    
                                    <div className="flex gap-2 mb-3">
                                        <button 
                                            onClick={() => { setInputType('manual'); setShowColumnSelector(false); }}
                                            className={`text-xs px-3 py-1 rounded border ${inputType === 'manual' ? 'bg-slate-100 border-slate-300 font-semibold' : 'border-transparent text-slate-400'}`}
                                        >
                                            Manual Entry
                                        </button>
                                        <button 
                                            onClick={() => setInputType('file')}
                                            className={`text-xs px-3 py-1 rounded border ${inputType === 'file' ? 'bg-slate-100 border-slate-300 font-semibold' : 'border-transparent text-slate-400'}`}
                                        >
                                            Upload File
                                        </button>
                                    </div>

                                    {inputType === 'manual' && !showColumnSelector ? (
                                        <textarea
                                            className="w-full h-32 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-[#184B44] focus:border-[#184B44] outline-none resize-none font-mono text-sm"
                                            placeholder="Enter values separated by commas (e.g., 10.5, 20.2, 5.1)"
                                            value={inputValue}
                                            onChange={(e) => setInputValue(e.target.value)}
                                        ></textarea>
                                    ) : null}
                                    
                                    {inputType === 'file' && !showColumnSelector ? (
                                        <div 
                                            className="h-32 border-2 border-dashed border-slate-300 rounded-lg flex flex-col items-center justify-center p-4 cursor-pointer hover:bg-slate-50 transition-colors"
                                            onClick={() => fileInputRef.current.click()}
                                        >
                                            <UploadCloud />
                                            <span className="text-sm text-slate-500 mt-2">Click to upload .csv or .txt</span>
                                            <input 
                                                type="file" 
                                                ref={fileInputRef} 
                                                className="hidden" 
                                                accept=".csv,.txt" 
                                                onChange={handleFileUpload} 
                                            />
                                        </div>
                                    ) : null}

                                    {/* Column Selector for File Upload */}
                                    {showColumnSelector && (
                                        <div className="p-4 bg-slate-50 border border-slate-200 rounded-lg animate-fade-up">
                                            <h4 className="text-sm font-semibold text-slate-700 mb-2">Select Column to Process:</h4>
                                            <select 
                                                className="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-[#184B44] outline-none text-sm mb-4"
                                                value={selectedColumn}
                                                onChange={(e) => setSelectedColumn(e.target.value)}
                                            >
                                                <option value="">-- Select Column --</option>
                                                {headers.map((h, i) => (
                                                    <option key={i} value={i}>{h || `Column ${i+1}`}</option>
                                                ))}
                                            </select>
                                            <div className="flex gap-2">
                                                <button onClick={handleFileProcess} className="btn-brand flex-grow justify-center text-xs">
                                                    Process Data
                                                </button>
                                                <button onClick={() => { setShowColumnSelector(false); setInputType('file'); }} className="btn-secondary text-xs">
                                                    Cancel
                                                </button>
                                            </div>
                                        </div>
                                    )}

                                    {!showColumnSelector && (
                                        <div className="mt-4">
                                            <button onClick={handleCalculate} className="btn-brand w-full justify-center">
                                                <Calculator /> Calculate
                                            </button>
                                        </div>
                                    )}
                                </div>

                                {/* Results Preview */}
                                <div className="bg-slate-50 rounded-lg border border-slate-200 p-4 flex flex-col h-full">
                                    <div className="flex justify-between items-center mb-3">
                                        <h4 className="text-sm font-semibold text-slate-700">Results Preview</h4>
                                        <div className="flex gap-2">
                                            <button onClick={copyToClipboard} className="p-1 hover:bg-white rounded text-slate-500 hover:text-[#184B44]" title="Copy"><Copy /></button>
                                            <button onClick={exportCSV} className="p-1 hover:bg-white rounded text-slate-500 hover:text-[#184B44]" title="Download CSV"><Download /></button>
                                        </div>
                                    </div>
                                    <div className="flex-grow overflow-y-auto max-h-60 bg-white border border-slate-100 rounded">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-slate-50 text-xs uppercase text-slate-500 sticky top-0">
                                                <tr>
                                                    <th className="px-4 py-2 border-b">Input ({mode === 'sd_to_var' ? 'SD' : 'Var'})</th>
                                                    <th className="px-4 py-2 border-b">Output ({mode === 'sd_to_var' ? 'Var' : 'SD'})</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {results.length === 0 ? (
                                                    <tr>
                                                        <td colSpan="2" className="px-4 py-8 text-center text-slate-400 italic">
                                                            No data calculated yet.
                                                        </td>
                                                    </tr>
                                                ) : (
                                                    results.map((row) => (
                                                        <tr key={row.id}>
                                                            <td className="px-4 py-2 font-mono text-slate-600 border-r border-slate-100">
                                                                {String(row.input)}
                                                            </td>
                                                            <td className={`px-4 py-2 font-mono font-medium ${row.error ? 'text-red-500' : 'text-[#184B44]'}`}>
                                                                {row.error ? (
                                                                    <span className="flex items-center gap-1 text-xs">
                                                                        <AlertCircle /> {row.error}
                                                                    </span>
                                                                ) : row.output.toFixed(4)}
                                                            </td>
                                                        </tr>
                                                    ))
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* References Section */}
                        <div className="max-w-3xl mx-auto mt-12 pt-8 border-t border-slate-200 animate-fade-up" style={{animationDelay: '0.3s'}}>
                            <h3 className="text-sm font-bold text-slate-800 mb-3 uppercase tracking-wider">Reference</h3>
                            <div className="text-xs text-slate-500 leading-relaxed">
                                <p>Altman, D. G., & Bland, J. M. (2005). Standard deviations and standard errors. BMJ, 331(7521), 903. <a href="https://doi.org/10.1136/bmj.331.7521.903" target="_blank" className="text-[#184B44] hover:underline">https://doi.org/10.1136/bmj.331.7521.903</a></p>
                            </div>
                        </div>

                    </main>


                    {/* Site Footer */}
                    <footer className="bg-white border-t border-slate-200">
                        <div className="max-w-7xl mx-auto px-6 py-8 flex flex-col items-center justify-center gap-4">
                            <div className="flex items-center gap-2 opacity-80 hover:opacity-100 transition-opacity">
                                <span className="text-sm font-semibold text-[#184B44]">Entro.py</span>
                                <span className="text-slate-300">|</span>
                                <span className="text-sm text-slate-500">Threadminds</span>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
